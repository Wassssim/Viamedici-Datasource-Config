<div class="container">
  <h2>Elasticsearch Document Editor</h2>

  <div *ngIf="errorMessage && !loading" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <div *ngIf="loading" class="spinner-container">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>

  <!-- Select Index -->
  <div *ngIf="indices.length">
    <label>Select Index:</label>
    <select
      [(ngModel)]="selectedIndex"
      (change)="loadDocuments()"
      class="form-control"
    >
      <option *ngFor="let index of indices" [value]="index">{{ index }}</option>
    </select>
  </div>

  <div class="input-group mb-3 search-input" *ngIf="selectedIndex">
    <input
      type="text"
      [(ngModel)]="searchString"
      class="form-control"
      placeholder="Search Documents"
      aria-label="Search"
      aria-describedby="basic-addon2"
    />
    <div class="input-group-append">
      <button
        class="btn btn-outline-secondary"
        type="button"
        (click)="search()"
      >
        Search
      </button>
    </div>
  </div>

  <button
    class="btn btn-primary my-3"
    (click)="openModal()"
    *ngIf="selectedIndex"
  >
    Add New Document
  </button>

  <app-add-document-modal
    (documentAdded)="onDocumentAdded($event)"
  ></app-add-document-modal>

  <!-- Documents Table -->
  <div class="documents">
    <h3 *ngIf="documents.length">Documents in {{ selectedIndex }}</h3>
    <table class="table table-striped" *ngIf="documents.length">
      <thead>
        <tr>
          <th>ID</th>
          <th>Data</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let doc of documents">
          <td>{{ doc.id }}</td>
          <td>
            <!-- Show JSON when not editing -->
            <pre *ngIf="editingDocumentId !== doc.id">{{ doc | json }}</pre>

            <!-- Show input fields when editing -->
            <div *ngIf="editingDocumentId === doc.id">
              <textarea
                class="form-control"
                [(ngModel)]="jsonString"
                (ngModelChange)="updateEditedDocument()"
              >
              </textarea>
            </div>
          </td>
          <td class="action-cell">
            <!-- Show Edit button if not editing -->
            <button
              *ngIf="editingDocumentId !== doc.id"
              class="btn btn-primary btn-sm"
              (click)="editDocument(doc)"
            >
              Edit
            </button>

            <!-- Show Save and Cancel buttons when editing -->
            <button
              *ngIf="editingDocumentId === doc.id"
              class="btn btn-success btn-sm"
              (click)="saveDocument()"
            >
              Save
            </button>
            <button
              *ngIf="editingDocumentId === doc.id"
              class="btn btn-secondary btn-sm"
              (click)="cancelEdit()"
            >
              Cancel
            </button>

            <!-- Delete button -->
            <button
              class="btn btn-danger btn-sm"
              (click)="deleteDocument(doc.id)"
            >
              Delete
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="spinner-container" *ngIf="loadingDocuments">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
    <div #sentinel class="sentinel"></div>
  </div>
</div>
